import telebot
import gspread
from datetime import date
import locale

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
TOKEN = "8424177109:AAHVSzi1UaamoihbdC0RzjheIfxSRtq2BvI"  # ‚Üê –≤—Å—Ç–∞–≤—å —Å–≤–æ–π —Ç–æ–∫–µ–Ω
SPREADSHEET_NAME = "Finance"

bot = telebot.TeleBot(TOKEN)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
gc = gspread.service_account(filename='service_account.json')
sh = gc.open(SPREADSHEET_NAME)
worksheet = sh.worksheet("Transactions")

# === –ö–ê–¢–ï–ì–û–†–ò–ò ===
categories = {
    "—Ä–∞—Å—Ö–æ–¥": [
        "–æ–±–µ–¥—ã", "–ø—Ä–æ–¥—É–∫—Ç—ã", "–≥–∏–≥–∏–µ–Ω–∞", "–∫–∞—Ñ–µ", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
        "–ø–æ–¥–ø–∏—Å–∫–∏", "–ø–æ–∫—É–ø–∫–∏", "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è", "–∑–¥–æ—Ä–æ–≤—å–µ",
        "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–ø–æ–¥–∞—Ä–∫–∏", "–¥—Ä—É–≥–æ–µ"
    ],
    "–¥–æ—Ö–æ–¥": [
        "–∑–∞—Ä–ø–ª–∞—Ç–∞", "—Å—Ç–∏–ø–µ–Ω–¥–∏—è", "—Å–ø–æ–Ω—Å–æ—Ä", "–≤—ã–ø–ª–∞—Ç—ã", "—Ñ—Ä–∏–ª–∞–Ω—Å", "–ø—Ä–æ—á–∏–µ"
    ]
}

# –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_state = {}

# === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ===
def type_keyboard():
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add('–¥–æ—Ö–æ–¥', '—Ä–∞—Å—Ö–æ–¥')
    return markup

def categories_keyboard(type_):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    for c in categories[type_]:
        markup.add(c)
    return markup

def yesno_keyboard():
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add("–î–∞", "–ù–µ—Ç")
    return markup

# –ú–∞–ø–ø–∏–Ω–≥ –º–µ—Å—è—Ü–µ–≤ ‚Äî –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
months_nominative = {
    "01": "—è–Ω–≤–∞—Ä—å", "02": "—Ñ–µ–≤—Ä–∞–ª—å", "03": "–º–∞—Ä—Ç", "04": "–∞–ø—Ä–µ–ª—å",
    "05": "–º–∞–π", "06": "–∏—é–Ω—å", "07": "–∏—é–ª—å", "08": "–∞–≤–≥—É—Å—Ç",
    "09": "—Å–µ–Ω—Ç—è–±—Ä—å", "10": "–æ–∫—Ç—è–±—Ä—å", "11": "–Ω–æ—è–±—Ä—å", "12": "–¥–µ–∫–∞–±—Ä—å"
}

# === –•–≠–ù–î–õ–ï–† /start ===
@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id, "üí∞ –í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", reply_markup=type_keyboard())

# === –í–´–ë–û–† –¢–ò–ü–ê ===
@bot.message_handler(func=lambda m: m.text and m.text.lower() in ['–¥–æ—Ö–æ–¥', '—Ä–∞—Å—Ö–æ–¥'])
def select_type(message):
    chat_id = message.chat.id
    t = message.text.lower()
    user_state[chat_id] = {"type": t}
    bot.send_message(chat_id, "üìÇ –í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", reply_markup=categories_keyboard(t))

# === –í–´–ë–û–† –ö–ê–¢–ï–ì–û–†–ò–ò ===
@bot.message_handler(func=lambda m: m.text and any(m.text in v for v in categories.values()))
def select_category(message):
    chat_id = message.chat.id
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª (–ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å)
    if chat_id not in user_state:
        bot.send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç–∏–ø (–¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥).", reply_markup=type_keyboard())
        return

    user_state[chat_id]["category"] = message.text
    # –°–ö–†–´–í–ê–ï–ú –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤–≤–æ–¥–∞ —Å—É–º–º—ã
    from telebot.types import ReplyKeyboardRemove
    bot.send_message(chat_id, "üíµ –í–≤–µ–¥–∏ —Å—É–º–º—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):", reply_markup=ReplyKeyboardRemove())

    # —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—É–º–º—ã
    bot.register_next_step_handler(message, get_amount)

# === –í–í–û–î –°–£–ú–ú–´ ===
def get_amount(message):
    chat_id = message.chat.id
    if chat_id not in user_state:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –Ω–∞—á–Ω–∏ —Å –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞.", reply_markup=type_keyboard())
        return
    try:
        user_state[chat_id]["amount"] = float(message.text.replace(',', '.'))
    except ValueError:
        bot.send_message(chat_id, "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã. –í–≤–µ–¥–∏ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1500).")
        bot.register_next_step_handler(message, get_amount)
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –î–∞/–ù–µ—Ç –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    bot.send_message(chat_id, "üìù –•–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?", reply_markup=yesno_keyboard())
    bot.register_next_step_handler(message, ask_note_choice)

# === –í–´–ë–û–†: –î–û–ë–ê–í–ò–¢–¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô? ===
def ask_note_choice(message):
    chat_id = message.chat.id
    if chat_id not in user_state:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –Ω–∞—á–Ω–∏ —Å –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞.", reply_markup=type_keyboard())
        return

    text = message.text.lower()
    if text == "–¥–∞":
        # –°–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ –∂–¥—ë–º —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–æ–±—ã—á–Ω—ã–π –≤–≤–æ–¥)
        from telebot.types import ReplyKeyboardRemove
        bot.send_message(chat_id, "‚úèÔ∏è –í–≤–µ–¥–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", reply_markup=ReplyKeyboardRemove())
        bot.register_next_step_handler(message, finalize_transaction_with_note)
    elif text == "–Ω–µ—Ç":
        finalize_transaction_with_note(message, skip_note=True)
    else:
        bot.send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ '–î–∞' –∏–ª–∏ '–ù–µ—Ç'.", reply_markup=yesno_keyboard())
        bot.register_next_step_handler(message, ask_note_choice)

# === –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø (—Å/–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è) ===
def finalize_transaction_with_note(message, skip_note=False):
    chat_id = message.chat.id
    if chat_id not in user_state:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ù–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ /start", reply_markup=type_keyboard())
        return

    note = "" if skip_note else message.text

    data = user_state[chat_id]
    # id: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—É—Å—Ç—ã—Ö –≤ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ (–≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫)
    id_value = len(worksheet.col_values(1))
    today = date.today()
    month_code = today.strftime("%m")
    month_nominative = months_nominative.get(month_code, today.strftime("%B").lower())

    row = [
        id_value,
        today.strftime("%Y-%m-%d"),
        month_nominative,    # –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
        data["type"],
        data["category"],
        data["amount"],
        note
    ]
    worksheet.append_row(row)

    bot.send_message(chat_id, f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ!")
    # –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø—Ä–µ–¥–ª–∂–µ–Ω–∏–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
    del user_state[chat_id]
    bot.send_message(chat_id, "–ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–ª—å—à–µ?", reply_markup=type_keyboard())

# === –ó–ê–ü–£–°–ö –ë–û–¢–ê ===
bot.polling(non_stop=True)
